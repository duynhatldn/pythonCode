USE Master
GO
IF EXISTS (SELECT * FROM sysdatabases WHERE name='cafe')
	DROP DATABASE cafe
GO
CREATE DATABASE cafe
GO
USE cafe
GO
 CREATE TABLE NhanVien( MaNV varchar(5),
						HoTen varchar(30),
						SoDT varchar(10),
						UserName varchar(50),
						PW varchar(50),
						CONSTRAINT pkNV PRIMARY KEY (MaNV)
						)
GO
 CREATE TABLE ThucUong( MaTU varchar(5),
						TenTU varchar(30),
						Gia int CHECK (Gia>5000),
						CONSTRAINT pkTU PRIMARY KEY (MaTU)
						)
GO
 CREATE TABLE HoaDon(   SoHD varchar(5),
						MaNV varchar(5),
						NgayHD date,
						TongGiaTri int,
						CONSTRAINT pkHD PRIMARY KEY (SoHD),
						CONSTRAINT pkHD1 FOREIGN KEY (MaNV) REFERENCES NhanVien(MaNV)
						)
GO
 CREATE TABLE CTHD(		SoHD varchar(5),
						MaTU varchar(5),
						SoLuong int DEFAULT 1 CHECK (SoLuong>0),
						CONSTRAINT pkCTHD PRIMARY KEY (SoHD, MaTU),
						CONSTRAINT pkCTHD1 FOREIGN KEY (SoHD) REFERENCES HoaDon(SoHD),
						CONSTRAINT pkCTHD2 FOREIGN KEY (MaTU) REFERENCES ThucUong(MaTU)
						)
GO
-- nhap du lieu 
INSERT INTO NHANVIEN VALUES ('A001','Nguyen Van A','0908070605','aaaa','123456789')
INSERT INTO NHANVIEN VALUES ('A002','Tran Van Le','0908040506','le','987654321')
INSERT INTO NHANVIEN VALUES ('A003','Le Van C','0901020304','ccc','147258369')
INSERT INTO NHANVIEN VALUES ('A004','Pham Van D D','0905040660','ddd','159753')
INSERT INTO NHANVIEN VALUES ('A005','Nguyen Van E','0904050201','eee','123789456')

INSERT INTO THUCUONG VALUES ('B001','Tra Dao',6000)
INSERT INTO THUCUONG VALUES ('B002','Tra Sua',10000)
INSERT INTO THUCUONG VALUES ('B003','Tra Vai',7500)
INSERT INTO THUCUONG VALUES ('B004','Nuoc suoi',5500)

INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C001','A001','2019/10/30')
INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C002','A001','2019/11/30')
INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C003','A002','2019/9/30')
INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C004','A004','2019/10/29')
INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C005','A003','2019/8/01')
INSERT INTO HOADON(Sohd,MaNV,Ngayhd) VALUES ('C006','A003','2019/10/25')

INSERT INTO CTHD VALUES ('C001','B001',20)
INSERT INTO CTHD VALUES ('C004','B003',60)
INSERT INTO CTHD VALUES ('C005','B002',10)
INSERT INTO CTHD VALUES ('C002','B001',50)
INSERT INTO CTHD VALUES ('C003','B004',12)
INSERT INTO CTHD VALUES ('C006','B002',25)
INSERT INTO CTHD VALUES ('C001','B004',7)
INSERT INTO CTHD VALUES ('C002','B003',5)

SELECT *
FROM NhanVien
WHERE HoTen LIKE '%LE%' 

SELECT TenTU
FROM ThucUong
WHERE Gia BETWEEN 6000 AND 8000

SELECT HoTen
FROM HoaDon H INNER JOIN NhanVien N ON H.MaNV=N.MaNV
WHERE MONTH(NgayHD)=10 AND YEAR(NgayHD)=2019

SELECT SoHD,SUM(SoLuong*Gia) TriGia
FROM CTHD C INNER JOIN ThucUong T ON C.MaTU=T.MaTU
GROUP BY SoHD

SELECT HoTen
FROM ThucUong T INNER JOIN CTHD C ON T.MaTU=C.MaTU
	INNER JOIN HoaDon H ON C.SoHD=H.SoHD
	INNER JOIN NhanVien N ON N.MaNV=H.MaNV 
WHERE TenTU='Tra Dao'

SELECT HoTen, COUNT(SoHD) SLHD
FROM NhanVien N INNER JOIN HoaDon H ON N.MaNV=H.MaNV
GROUP BY HoTen

IF EXISTS (SELECT * FROM sysobjects WHERE name='TinhTriGia')
DROP PROCEDURE TinhTriGia
GO
CREATE PROCEDURE TinhTriGia
AS
BEGIN
UPDATE HoaDon
SET TongGiaTri = (SELECT SUM(SoLuong*Gia) TriGia
				  FROM CTHD C INNER JOIN ThucUong T ON C.MaTU=T.MaTU
				  WHERE HoaDon.SoHD=C.SoHD
				  GROUP BY C.SoHD);
END
EXEC TinhTriGia


